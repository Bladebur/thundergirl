/*! thundergirl | v1.0.0 | 2022-06-07 */

var DONE=0,NOTDONE=1,WAIT=2,ASK=3,NOACTION=-1;function isEmpty(t){for(var e in t)return!1;return!0}function isSingle(t){var e=0;for(var i in t)null!==i&&e++;return 1==e}function capitalizeFirstLetter(t){return t.charAt(0).toUpperCase()+t.slice(1)}var AdventureObject=function(e,i){this.reset=function(){if(this.key=e,this.many=!1,this.wearable=!1,this.worn=!1,this.scenery=!1,this.seen=!1,this.name="",this.description=null,this.proper=!1,this.hidden=!1,this.noun=null,this.adjective=null,this.printLocationNames=!1,this.exitNames={},i)for(var t in i)this[t]=i[t]},this.reset()};AdventureObject.prototype.fullName=function(t){var e=this.name,i=t&&this.inventoryDetails||this.details;return"function"==typeof i&&(i=i.call(this)),i&&(e+=" ("+i+")"),e},AdventureObject.prototype.reset=function(){var t=new AdventureObject;for(var e in t)this[e]=e};var Order=function(){this.verb="",this.verbAsWritten="",this.verb2="",this.verb2AsWritten="",this.adjective="",this.adjectiveAsWritten="",this.noun="",this.nounAsWritten="",this.noun2="",this.noun2AsWritten="",this.adverb="",this.adverbAsWritten="",this.preposition="",this.prepositionAsWritten="",this.prepositionAfter="",this.conjuntion="",this.conjuntionAsWritten="",this.quotedText="",this.remainingText="",this.unknownWords=0,this.object=null},AdventureLocation=function(e,i){this.reset=function(){if(this.key=e,this.description="",this.name="",this.exits={},this.seen=!1,i)for(var t in i)this[t]=i[t]},this.reset()},AdventureCharacter=function(){this.maxObjectsCarried=99,this.inventory=[],this.location="destroyed",this.sitting=""},Adventure=function(){this.modules=[],this.vocabulary={},this.synonyms={},this.order=null,this.remainingText="",this.currentMessage="",this.objects=[],this.locations=[],this.areas={},this.variables={},this.player=new AdventureCharacter,this.initialState=null,this.askPrompt="",this.askCallback=null,this.textWindow=null,this.currentOrder=null,this.waitOrder=null,this.askOrder=null,this.thirdPerson=!0};Adventure.prototype.addWordsFrom=function(t){if(t.verbs&&this.addWords("verb",t.verbs),t.convertibleNouns&&this.addWords("convertibleNoun",t.convertibleNouns),t.directions&&this.addWords("direction",t.directions),t.specialNouns&&this.addWords("specialNoun",t.specialNouns),t.nouns&&this.addWords("noun",t.nouns),t.prepositions&&this.addWords("preposition",t.prepositions),t.conjunctions&&this.addWords("conjunction",t.conjunctions),t.adjectives&&this.addWords("adjective",t.adjectives),t.adverbs&&this.addWords("adverb",t.adverbs),t.pronouns&&this.addWords("pronoun",t.pronouns),t.responses&&this.addResponseWords(t.responses),t.synonyms)for(var e in t.synonyms)this.synonyms[e]=t.synonyms[e]},Adventure.prototype.addModule=function(t){var e;if(this.modules.push(t),(t.adventure=this).addWordsFrom(t),t.areas&&this.addAreas(t.areas),t.locations&&this.addLocations(t.locations),t.objects&&this.addObjects(t.objects),t.variables)for(e in t.variables)this.variables[e]=t.variables[e];if(t.exitNames)for(e in this.exitNames||(this.exitNames={}),t.exitNames)this.exitNames[e]=t.exitNames[e]},Adventure.prototype.addWords=function(t,e){if(void 0!==e)for(var i in e){var n=e[i];if(i in this.vocabulary||(this.vocabulary[i]=t),"string"==typeof n)""!==n&&(this.synonyms[n]=i);else for(var s=0;s<n.length;s++)this.synonyms[n[s]]=i}},Adventure.prototype.serialize=function(){return JSON.stringify({objects:this.objects,locations:this.locations,player:this.player,variables:this.variables})},Adventure.prototype.serializeDifferences=function(t){function e(t,e){var i={},n=!1;if(!e)return console.log("WARNING: no originals"),[];for(var s in Array.isArray(e)&&(n=!0),t)if(s in e){var r=t[s],o=null;if(n){for(var a in s=r.key,e)if(e[a].key===s){o=e[a];break}if(null===o){console.log("WARNING: object "+s+" not in originals");continue}}else o=e[s];if("object"==typeof r){var h={},u=!1;for(var c in r)"object"!=typeof r[c]&&(void 0!==o[c]&&o[c]===r[c]||(h[c]=r[c],u=!0));u&&(i[s]=h)}else r!==o&&(i[s]=r)}else i[s]=t[s];return i}t=JSON.parse(t);var i={objects:e(this.objects,t.objects),locations:e(this.locations,t.locations),player:e(this.player,t.player),variables:e(this.variables,t.variables)};return JSON.stringify(i)},Adventure.prototype.unserialize=function(t){function n(t,e){if(null===e)return t;if("object"!=typeof e)return e;for(var i in e)t[i]=n(t[i],e[i]);return t}if(!(t=JSON.parse(t)))return NOTDONE;t.objects&&(this.objects=n(this.objects,t.objects)),t.player&&(this.player=n(this.player,t.player)),t.locations&&(this.locations=n(this.locations,t.locations)),t.variables&&(this.variables=n(this.variables,t.variables))},Adventure.prototype.unserializeDifferences=function(t){function e(t,e){var i,n=[];for(i in e)n.push(null);for(var s in t)for(i in e)e[i].key===s&&(n[i]=t[s]);return n}t=JSON.parse(t),this.unserialize(JSON.stringify({objects:e(t.objects,this.objects),locations:e(t.locations,this.locations),player:t.player,variables:t.variables}))},Adventure.prototype.addAreas=function(t){for(var e in t)this.areas[e]=t[e],this.addWordsFrom(t[e])},Adventure.prototype.addLocations=function(t){for(var e in t)this.locations.push(new AdventureLocation(e,t[e])),this.addWordsFrom(t[e])},Adventure.prototype.addObjects=function(t){for(var e in t){var i=new AdventureObject(e,t[e]);if(i.name||(i.name=e),!i.noun){var n=i.name.split(" "),s=0;i.proper&&(s=1);for(var r=s;r<n.length-1;r++)n[r]in this.vocabulary||(this.vocabulary[n[r]]="adjective",i.adjective=n[r]);var o=n[n.length-1];o in this.vocabulary||(this.vocabulary[o]="noun"),i.noun=o}this.objects.push(i)}},Adventure.prototype.exitsFrom=function(t){var e=[];if(!t.exits)return e;for(var i in t.exits){var n=i;t.exitNames&&t.exitNames[n]&&(n=t.exitNames[n]),this.exitNames&&this.exitNames[n]&&(n=this.exitNames[n]),t.directions&&t.directions[i]&&(n=n+" ("+t.directions[i]+")"),e.push({name:n,proper:!0})}return e},Adventure.prototype.parsedProperObjectName=function(t){for(var e="",i=0,n=0;n<t.name.length;n++)if("["!=t.name.charAt(n));else{for(e+=t.name.substring(i,n),i=n+1;n<t.name.length&&"]"!=t.name.charAt(n);)n++;var s=t.name.substring(i,n);switch(s){case"your":case"yours":this.thirdPerson?e+=s:e+="my";break;default:e+=s}i=n+1}return e+t.name.substring(i,t.name.length)},Adventure.prototype.parseMessageCode=function(t,e){e&&"string"==typeof e&&(e={name:e,fullName:function(){return this.name}}),e||(e={name:"that",fullName:function(){return this.name},proper:!0});var i="",n=" and ";switch(t){case"You":case"you":this.thirdPerson?i+=t:i+="I";break;case"me":this.thirdPerson?i+="you":i+=t;break;case"Me":this.thirdPerson?i+="You":i+=t;break;case"Your":this.thirdPerson?i+=t:i+="My";break;case"your":this.thirdPerson?i+=t:i+="my";break;case"yourself":this.thirdPerson?i+=t:i+="myself";break;case"yours":this.thirdPerson?i+=t:i+="mine";break;case"Yours":this.thirdPerson?i+=t:i+="Mine";break;case"You'd":case"you'd":this.thirdPerson?i+=t:i+="I'd";break;case"You're":case"you're":this.thirdPerson?i+=t:i+="I'm";break;case"You were":case"you were":this.thirdPerson?i+=t:i+="I was";break;case"You are":case"you are":this.thirdPerson?i+=t:i+="I am";break;case"the options":n=" or ";case"list":case"a list":case"the list":case"List":case"A list":case"The list":for(var s=t.replace(" list"," object").replace(" options"," object"),r=0;r<e.length;r++)i+=this.parseMessageCode(s,e[r]),s=s.toLowerCase(),r<e.length-2?i+=", ":r<e.length-1&&(i+=n);break;case"object":e.proper?i+=this.parsedProperObjectName(e):i+=e.fullName(this.inventoryMode),e.seen=!0;break;case"A object":case"An object":if(!e.seen){e.proper?i+=capitalizeFirstLetter(this.parsedProperObjectName(e)):e.many?i+=capitalizeFirstLetter(e.fullName(this.inventoryMode)):e.name.substring(0,1).match(/[aeiou]/i)?i+="An "+e.fullName(this.inventoryMode):i+="A "+e.fullName(this.inventoryMode),e.seen=!0;break}case"The object":e.proper?i+=capitalizeFirstLetter(this.parsedProperObjectName(e)):i+="The "+e.fullName(this.inventoryMode),e.seen=!0;break;case"a object":case"an object":if(!e.seen){e.proper?i+=this.parsedProperObjectName(e):e.many?i+=e.fullName(this.inventoryMode):e.name.substring(0,1).match(/[aeiou]/i)?i+="an "+e.fullName(this.inventoryMode):i+="a "+e.fullName(this.inventoryMode),e.seen=!0;break}case"the object":e.proper?i+=this.parsedProperObjectName(e):i+="the "+e.fullName(this.inventoryMode),e.seen=!0;break;default:if(t.match(/^[Yy]ou.*\|/)){var o=t.split("|");this.thirdPerson?i+=o[0]:i+=o[1]}else console.log('Unknown special message code "'+t+'"')}return i},Adventure.prototype.processMessage=function(t){var e=this.currentMessage;this.currentMessage="",this.mess(t);var i=this.currentMessage;return this.currentMessage=e,i},Adventure.prototype.parseMessage=function(t,e){for(var i=0,n="",s=0;s<t.length;s++)if("["!=t.charAt(s));else{for(n+=t.substring(i,s),i=s+1;s<t.length&&"]"!=t.charAt(s);)s++;n+=this.parseMessageCode(t.substring(i,s),e),i=s+1}return n+=t.substring(i)},Adventure.prototype.mess=function(t,e){var i=this.parseMessage(t,e);this.currentMessage&&"\n"==this.currentMessage.slice(-1)&&!i.match(/^[ <]/)&&(this.currentMessage+="   "),this.currentMessage+=i},Adventure.prototype.waitForKey=function(e){if(this.textWindow){var i=this;this.waitOrder=this.currentOrder,this.textWindow.print(this.currentMessage),this.currentMessage="",this.textWindow.waitForKey(function(){var t=DONE;e&&(t=e()),t!=WAIT&&(i.textWindow.print(i.currentMessage),i.currentMessage="",i.resolveTurn(i.waitOrder,t),i.waitOrder=null,i.textWindow.print("\n"),i.textWindow.startInput())})}},Adventure.prototype.message=function(t,e){return this.mess(t+"\n",e)},Adventure.prototype.findLocation=function(t){for(var e in this.locations)if(this.locations[e].key===t)return this.locations[e];return null},Adventure.prototype.objectsHere=function(){var t=[];for(var e in this.objects){var i=this.objects[e];("inventory"==i.location||this.inReach(i.location))&&t.push(i)}return t},Adventure.prototype.inReach=function(t){if("object"==typeof t&&(t=t.key),"inventory"===t)return!0;if(t===this.player.location)return!0;var e=this.findLocation(this.player.location);if(t===e.reach)return!0;if("function"==typeof e.reach&&e.reach(t,this))return!0;if("object"==typeof e.reach)for(var i in e.reach)if(e.reach[i]===t)return!0;return!1},Adventure.prototype.present=function(t){return"inventory"===t.location||this.inReach(t.location)},Adventure.prototype.findObject=function(t){for(var e in this.objects)if(this.objects[e].key===t)return this.objects[e];return null},Adventure.prototype.objectsAt=function(e){return"object"==typeof e&&(e=e.key),this.objects.filter(function(t){return t.location===e})},Adventure.prototype.isPresent=function(t){return"string"==typeof t&&(t=this.findObject(t)),!(!t||t.location!==this.player.location&&"inventory"!==t.location)},Adventure.prototype.describe=function(t){var e,i;for(t||(t=this.player.location),"string"==typeof t&&(t=this.findLocation(t)),e=this.modules.length-1;0<=e;e--)if((!(i=this.modules[e]).conditions||i.conditions(this))&&i.beforeDescription&&i.beforeDescription(t,this)===NOTDONE)return NOTDONE;!t.seen&&this.printLocationNames&&this.message("<b>[object]</b>",t),t.seen=!0,this.message(t.description);var n=this.player.location,s=this.objects.filter(function(t){return t.location===n&&!t.hidden});0<s.length&&this.message("   [You] can see [a list] here.",s);var r=DONE;for(e=this.modules.length-1;0<=e;e--)(i=this.modules[e]).conditions&&!i.conditions(this)||i.afterDescription&&(r=i.afterDescription(t,this)||r);return DONE},Adventure.prototype.setTextWindow=function(t){var e=this;this.textWindow=t,this.textWindow.oninput=function(t){e.processInputText(t)}},Adventure.prototype.restartGame=function(){for(var t=NOACTION,e=0;e<this.modules.length;e++){var i=this.modules[e];if(i.startGame){var n=i.startGame(this);if(void 0===n)continue;n!==NOACTION&&t===NOACTION&&(t=n)}}!1===this.textWindow.waitingForKey&&t!=WAIT&&(this.describe(this.player.location),this.textWindow.print(this.currentMessage),this.currentMessage="",this.textWindow.print("\n"),this.textWindow.startInput())},Adventure.prototype.flushStart=function(){this.describe(this.player.location),this.textWindow.print(this.currentMessage),this.currentMessage="",this.textWindow.print("\n"),this.textWindow.startInput()},Adventure.prototype.startGame=function(){for(var t=0;t<this.modules.length;t++){var e=this.modules[t];e.initialize&&e.initialize(this)}this.initialState=this.serialize(),this.restartGame()},Adventure.prototype.processInputText=function(t){var e=this.execute(t),i=this.textWindow;switch(i.print(this.currentMessage),this.currentMessage="",e){case NOACTION:i.print(this.processMessage("[You] can't do that.\n")),i.print("\n"),i.startInput();break;case WAIT:break;case ASK:var n=i.inputPrompt,s=i.inputPromptFinal,r=this;i.inputPrompt="<r>"+this.askPrompt,i.inputPromptFinal="<r>"+this.askPrompt,i.startInput(function(t){var e=DONE;r.askCallback&&(e=r.askCallback(t)),i.print(r.currentMessage),r.currentMessage="",r.resolveTurn(r.askOrder,e),e!==DONE&&e!==NOTDONE||(i.print("\n"),i.startInput()),i.inputPrompt=n,i.inputPromptFinal=s});break;default:i.print("\n"),i.startInput()}},Adventure.prototype.parse=function(t){var e=new Order,i=0,n=null,s=!1;t=t.toLowerCase()+" ";for(var r=0;r<t.length;r++){var o=t.charAt(r);if('"'!=o&&"'"!=o){if(o.match(/[ .,;:?]/)){if(i==r)i++;else{var a=t.substring(i,r);i=r+1;var h=a;if(a in this.synonyms&&(a=this.synonyms[a]),!(a in this.vocabulary)){console.log("Word '"+a+"' not in vocabulary; ignored"),e.unknownWords||(e.unknownWords=0),e.unknownWords++,n=null;continue}switch(this.vocabulary[a]){case"conjuntion":e.conjuntion=a,e.conjuntionAsWritten=h,e.remainingText=t.substring(r+1);break;case"direction":e.direction=a,e.directionAsWritten=h,e.remainingText=t.substring(r+1);break;case"verb":e.verb&&!e.verb2?(e.verb2=a,e.verb2AsWritten=h):e.verb||(e.verb=a,e.verbAsWritten=h);break;case"pronoun":e.noun&&!e.noun2?(e.noun2=this.lastNoun,e.noun2AsWritten=this.lastNounAsWritten):e.noun||(e.noun=this.lastNoun,e.nounAsWritten=this.lastNounAsWritten);break;case"convertibleNoun":e.verb?e.noun&&!e.noun2?(e.noun2=a,e.noun2AsWritten=h):e.noun||(e.noun=a,e.nounAsWritten=h,s=!0):(e.verb=a,e.verbAsWritten=h);break;case"noun":e.noun&&!e.noun2?(e.noun2=a,e.noun2AsWritten=h):e.noun||(e.noun=a,e.nounAsWritten=h);break;case"specialNoun":e.noun&&!e.noun2?(e.noun2=a,e.noun2AsWritten=h):e.noun||(s=!0,e.noun=a,e.nounAsWritten=h);break;case"preposition":e.preposition||(e.preposition=a,e.prepositionAsWritten=h,e.prepositionAfter=n);break;case"adverb":e.adverb||(e.adverb=a,e.adverbAsWritten=h);break;case"adjective":e.noun2?e.adjective2||(e.adjective2=a,e.adjective2AsWritten=h):e.noun&&"noun"==n?e.adjective||(e.adjective=a,e.adjectiveAsWritten=h):e.noun?e.adjective2||(e.adjective2=a,e.adjective2AsWritten=h):e.adjective||(e.adjective=a,e.adjectiveAsWritten=h)}if(e.conjuntion)break;n=this.vocabulary[a]}if(e.adjective2&&!e.noun2&&(e.adjective=e.adjective2,e.adjectiveAsWritten=e.adjective2AsWritten,e.adjective2="",e.adjective2AsWritten=""),("."==o||","==o||";"==o||":"==o)&&!isEmpty(e)){e.remainingText=t.substring(r+1);break}}}else{for(i=r+1;r<t.length-1;){if(t.charAt(++r)==o)break}e.quotedText=t.substring(i,r),i=r+1}}return e.noun&&!1===s&&(this.lastNoun=e.noun,this.lastNounAsWritten=e.nounAsWritten),e.noun&&(e.object=this.findObjectByNoun(e.noun,e.adjective)),e.noun2&&(e.object2=this.findObjectByNoun(e.noun2,e.adjective2)),e},Adventure.prototype.findObjectByNoun=function(t,e){var i=[];for(var n in this.objects){var s=this.objects[n];s.noun==t&&i.push(s)}if(1==i.length)return i[0];if(null!==e&&1<i.length){for(var r=[],o=0;o<i.length;o++)i[o].adjective==e&&r.push(i[o]);if(1==r.length)return r[0];if(1<r.length)return r}return 1<i.length?i:null},Adventure.prototype.check=function(t){for(var e=this.modules.length-1;0<=e;e--){var i=this.modules[e];if((!i.conditions||i.conditions(this))&&(i.check&&!i.check(t,this)))return!1}return!0},Adventure.prototype.resolveTurn=function(t,e){var i,n;if(e===DONE)for(n=this.modules.length-1;0<=n;n--){var s=this.modules[n];if(!s.conditions||s.conditions(this)){if(s.after&&null!=(i=s.after(t,this))&&i!==DONE){e=i;break}if(s.afterTurn&&null!=(i=s.afterTurn(t,this))&&i!==DONE){e=i;break}}}if(e===DONE){var r=this.objectsHere();for(n in r)if(r[n].afterTurn&&null!=(i=r[n].afterTurn(t,this))&&i!==DONE){e=i;break}}return e===DONE?t&&t.remainingText&&(e=this.execute(t.remainingText))!=NOACTION?e:DONE:e===NOTDONE?NOTDONE:e==WAIT?(this.waitOrder=t,this.remainingText=t.remainingText,WAIT):e==ASK?(this.askOrder=t,this.remainingText=t.remainingText,ASK):(console.log("Invalid turn result: "+e),NOTDONE)},Adventure.prototype.addResponseWords=function(t){for(var e in t)for(var i=e.split(","),n=0;n<i.length;n++)for(var s=i[n].trim().split(" "),r=0;r<s.length;r++)this.synonyms[s[r]]||"*"!==s[r]&&"_"!==s[r]&&(s[r]in this.vocabulary?0===r&&"noun"==this.vocabulary[s[r]]&&(this.vocabulary[s[r]]="convertibleNoun"):this.vocabulary[s[r]]=0<r?"noun":"verb")},Adventure.prototype.checkResponses=function(t,e){if(this.skipResponses)return NOACTION;var i,n=NOACTION,s=[e.noun,e.noun2];if(t.responses)for(i in t.responses)for(var r=i.split(","),o=0;o<r.length;o++){var a=r[o].trim().split(" ");if(!(a.length<1)){for(var h=0;h<a.length;h++)this.synonyms[a[h]]&&(a[h]=this.synonyms[a[h]]);if("*"===a[0]||"_"===a[0]||a[0]===e.verb||a[0]===e.direction){for(var u=!0,c=0,l=1;l<a.length;l++)"*"!==a[l]&&"_"!==a[l]&&a[l]!==s[c]&&a[l]!==e.preposition&&(u=!1),"_"!==a[l]&&"*"!==a[l]&&a[l]!==s[c]||c++;if(u){switch(typeof t.responses[i]){case"string":if(n=DONE,"*"==t.responses[i].charAt(0))this.message(t.responses[i].substring(1)),n=NOTDONE;else if(">"==t.responses[i].charAt(0))n=this.execute(e,t.responses[i].substring(1));else if("!"==t.responses[i].charAt(0)){var f=this.currentMessage;this.skipResponses=!0,n=this.execute(e),this.skipResponses=!1,n==DONE&&(this.currentMessage=f,this.message(t.responses[i].substring(1)))}else this.message(t.responses[i]);break;case"object":this.message(t.responses[i][0]),null==(n=t.responses[i][1])&&(n=NOACTION);break;case"function":null==(n=t.responses[i].call(t,e,this))&&(n=NOACTION)}if(n!=NOACTION)return n}}}}var d,p=t.areas;if(!p&&t.area&&(p=t.area),p)if("string"==typeof p){if((d=this.areas[p])&&(n=this.checkResponses(d,e))!=NOACTION)return n}else for(i in p)if((d=this.areas[p[i]])&&(n=this.checkResponses(d,e))!=NOACTION)return n;return NOACTION},Adventure.prototype.execute=function(t,e){var i,n,s,r,o="string"==typeof t?this.parse(t):t;if(e)if("string"==typeof e){var a=this.parse(e);for(r in a)a[r]&&(o[r]=a[r])}else for(r in e)o[r]=e[r];if(isEmpty(o))return NOACTION;for(this.currentOrder=o,i=NOACTION,n=this.modules.length-1;0<=n;n--)if((!(s=this.modules[n]).conditions||s.conditions(this))&&s.before&&(null==(i=s.before(o,this))&&(i=NOACTION),i===NOTDONE))return NOTDONE;var h=this.findLocation(this.player.location);if(h&&h.before&&(null==(i=h.before(o,this))&&(i=NOACTION),i===NOTDONE))return i;if(o.object&&this.present(o.object)){if(o.object.before&&(null==(i=o.object.before(o,this))&&(i=NOACTION),i===NOTDONE))return i;if(o.object.execute&&(i=o.object.execute(o,this)),i===NOACTION&&(i=this.checkResponses(o.object,o)),i!==NOACTION)return this.resolveTurn(o,i)}if(h&&(h.execute&&(i=h.execute(o,this)),i===NOACTION&&(i=this.checkResponses(h,o)),i!==NOACTION))return this.resolveTurn(o,i);for(n=this.modules.length-1;0<=n;n--)if((!(s=this.modules[n]).conditions||s.conditions(this))&&(i=NOACTION,s.execute&&(i=s.execute(o,this)),i===NOACTION&&s.responses&&(i=this.checkResponses(s,o)),i!==NOACTION))return this.resolveTurn(o,i);return this.remainingText=o.remainingText,NOACTION};var LRPlugin,adventure=new Adventure;window.LiveReloadPluginAT=LRPlugin=function(){LRPlugin.identifier="at",LRPlugin.version="1.0",LRPlugin.prototype.reload=function(t,e){return window.localStorage.setItem("livereloadState",adventure.serializeDifferences(adventure.initialState)),!1}};for(var colors={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"},cp437toiso8859=[0,9786,9787,9829,9830,9827,9824,8226,9688,9675,9689,9794,9792,9834,9835,9788,9658,9668,8597,8252,182,167,9644,8616,8593,8595,8594,8592,8735,8596,9650,9660,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,199,252,233,226,228,224,229,231,234,235,232,239,238,236,196,197,201,230,198,244,246,242,251,249,255,214,220,162,163,165,8359,402,225,237,243,250,241,209,170,186,191,8976,172,189,188,161,171,187,9617,9618,9619,9474,9508,9569,9570,9558,9557,9571,9553,9559,9565,9564,9563,9488,9492,9524,9516,9500,9472,9532,9566,9567,9562,9556,9577,9574,9568,9552,9580,9575,9576,9572,9573,9561,9560,9554,9555,9579,9578,9496,9484,9608,9604,9612,9616,9600,945,223,915,960,931,963,181,964,934,920,937,948,8734,966,949,8745,8801,177,8805,8804,8992,8993,247,8776,176,8729,183,8730,8319,178,9632,160],iso8859tocp437={},i=0;i<256;i++)iso8859tocp437[cp437toiso8859[i]]=i;adventure.addModule({directions:{north:"n",south:"s",east:"e",west:"w",northeast:"ne",northwest:"nw",southeast:"se",southwest:"sw",up:[],down:[],enter:["in","inside"],leave:["out","outside"]},convertibleNouns:{inventory:"i",exits:["x"]},prepositions:{into:["inside","in"],on:["over"],under:[],off:[],at:[]},exitNames:{enter:"inside",leave:"outside",north:"North",south:"South",east:"East",west:"West",northeast:"Northeast",northwest:"Northwest",southeast:"Southeast",southwest:"Southwest"},verbs:{enter:[],exit:["leave"],take:["get","pick"],drop:["throw"],wear:["don"],put:[],remove:["disrobe","unwear","doff"],look:["re-describe","l"],quit:["end","quitf"],save:[],load:["restore"],say:["speak","talk","tell"],open:[],close:[],punch:["fight","strike","punch","kick","attack"],restart:[],break:["destroy","split"],pick:[],examine:["ex","check","read","search","find","scan","investigate","inspect"],make:[],sit:[],lay:["lie","crouch"],stand:[]},specialNouns:{all:["everything"],ram:[],floor:[]},pronouns:{it:[],them:[]},conjunctions:{and:[],then:[]},afterDescription:function(t,e){!0===e.player.sitting?e.message("   [You are] "+e.player.sittingMode+" down on the floor."):e.player.sitting&&e.message("   [You are] "+e.player.sittingMode+" down on [the object].",e.findObject(e.player.sitting))},before:function(t,e){"pick"===t.verbAsWritten&&"up"==t.noun&&t.object2&&(t.object=t.object2),"put"===t.verbAsWritten&&"on"==t.preposition&&"verb"===t.prepositionAfter&&(t.verb="wear"),"put"!==t.verbAsWritten||t.noun2||(t.verb="wear"),"take"===t.verbAsWritten&&"off"==t.noun&&t.object2&&(t.verb="remove",t.object=t.object2),"make"==t.verbAsWritten&&"inventory"==t.noun&&(t.verb="inventory"),"x"==t.verbAsWritten&&(t.noun||t.unknownWords)&&(t.verb="examine"),"enter"==t.verb&&(t.direction="enter",t.directionAsWritten=t.verbAsWritten,t.verb=t.verbAsWritten=void 0),"exit"==t.verb&&(t.direction="leave",t.directionAsWritten=t.verbAsWritten,t.verb=t.verbAsWritten=void 0),"into"!=t.preposition||t.noun||t.verb||t.unknownWords||(t.direction="enter",t.directionAsWritten=t.prepositionAsWritten,t.preposition=t.prepositionAsWritten=void 0),"sit"==t.verb&&"down"==t.direction&&(t.direction=""),"get"==t.verbAsWritten&&"up"==t.direction&&(t.verb="stand",t.direction="")},execute:function(t,e){var i,n,s,r,o,a=e.player,h=e.findLocation(a.location),u=t.object;if(t.direction&&!t.verb){if(t.direction in h.exits){if(!e.check(t))return NOTDONE;var c=h.exits[t.direction],l=e.findLocation(c);if(!l)return e.message("[You] can't go "+t.direction+"."),NOTDONE;if(e.player.sitting&&(s=e.execute("stand up"))!==DONE)return s;if(a.location=c,l.seen)e.mess("<font 1>"+(l.brief||l.name)+"</font>\n");else if(s=e.describe(a.location))return s;return DONE}return"up"==t.direction&&e.player.sitting?e.execute("stand up"):(e.mess("[You] can't go that way. "),isEmpty(h.exits)?e.message("There is no exit."):1==isSingle(h.exits)?e.message("[You] can only go [the options].",e.exitsFrom(h)):e.message("[You] can go [the options].",e.exitsFrom(h)),NOTDONE)}switch(t.verb){case"exits":var f=e.exitsFrom(h);return isEmpty(f)?e.message("There is no exit."):1==isSingle(h.exits)?e.message("[You] can only go [the options].",f):e.message("[You] can go [the options].",f),NOTDONE;case"restart":return e.askPrompt="Are you sure? ",e.askCallback=function(t){return"y"==t.substring(0,1).toLowerCase()?(e.unserialize(e.initialState),e.mess("<clear>"),e.restartGame(),WAIT):NOTDONE},ASK;case"load":var d=window.localStorage.getItem("savedState");if(d){if(e.unserialize(e.initialState),e.unserializeDifferences(d),e.mess("<clear>"),s=e.describe(a.location))return s}else e.message("Your progress hasn't been saved yet.");return NOTDONE;case"save":return window.localStorage.getItem("savedState")?(e.message("This will overwrite your previous save."),e.askPrompt="Are you sure? ",e.askCallback=function(t){return"y"==t.substring(0,1).toLowerCase()&&(window.localStorage.setItem("savedState",e.serializeDifferences(e.initialState)),e.message("Progress saved.")),NOTDONE},ASK):(window.localStorage.setItem("savedState",e.serializeDifferences(e.initialState)),e.message("Progress saved."),NOTDONE);case"inventory":e.inventoryMode=!0;var p=e.objects.filter(function(t){return"inventory"===t.location&&!t.hidden&&!t.worn}),g=e.objects.filter(function(t){return"inventory"===t.location&&!t.hidden&&t.worn});return 0===p.length&&0===g.length&&e.message("[You are] not carrying anything."),0<p.length&&e.message("[You are] carrying [a list].",p),0<g.length&&e.message("[You are] wearing [a list].",g),e.inventoryMode=!1,DONE;case"look":return t.noun?"exits"==t.noun?e.execute({verb:"exits"}):e.execute(t,{verb:"examine"}):(s=e.describe(a.location))||DONE;case"examine":if(u){if(e.present(u)){if(!e.check(t))return NOTDONE;if(u.description)if("function"==typeof u.description){var v=u.description.call(u,e);v&&e.message(v)}else e.message(u.description);else e.message("[The object] has nothing special.",u);return DONE}if(u.seen)return e.message("[You] can't see [the object] here.",u),NOTDONE}return e.message("[You] can see nothing special."),DONE;case"drop":if(u){if("inventory"==u.location){if(u.worn){if(r=e.currentMessage,(s=e.execute(t,{verb:"remove"}))!=DONE)return s;e.currentMessage=r}return e.check(t)?(u.location=a.location,e.message("[You drop|I've dropped] [the object].",u),DONE):(u.worn=!1,NOTDONE)}if(e.present(u))return e.message("[You are] not carrying [the object].",u),NOTDONE}else if("all"===t.noun){if(0===(n=e.objects.filter(function(t){return"inventory"===t.location&&!t.worn&&!t.hidden})).length)return e.message("[You are] not carrying anything."),NOTDONE;for(i in n)if(t.noun=n[i].noun,t.adjective=n[i].adjective,!e.check(t))return NOTDONE;for(i in n)n[i].location=a.location;return e.message("[You drop|I've dropped] [the list].",n),DONE}return e.message("[You are] not carrying that."),NOTDONE;case"take":if(u)return"inventory"==u.location?(e.message("[You are] already carrying [the object].",u),NOTDONE):e.present(u)?u.scenery?(e.message("That's hardly something [you] can carry around."),NOTDONE):e.objects.filter(function(t){return"inventory"===t.location}).length>=a.maxObjectsCarried?(e.message("[You are] carrying too many things."),NOTDONE):e.check(t)?(e.message("[You] now have [the object].",u),u.location="inventory",DONE):NOTDONE:(e.message("[You] can't see that."),NOTDONE);if("all"!=t.noun)return t.noun||t.unknownWords?e.message("[You] can't pick up that."):e.message("[You] can't see that."),NOTDONE;if(0===(n=e.objects.filter(function(t){return t.location===a.location&&!t.scenery&&!t.hidden})).length)return e.message("[You] can see nothing suitable."),NOTDONE;if(e.objects.filter(function(t){return"inventory"===t.location}).length+n.length>a.maxObjectsCarried)return e.message("[You are] carrying too many things."),NOTDONE;for(i in n)if(t.noun=n[i].noun,t.adjective=n[i].adjective,!e.check(t))return NOTDONE;for(i in n){n[i].location="inventory"}return e.message("[You] now have [the list].",n),DONE;case"remove":if(u&&"inventory"==u.location&&u.worn)return e.check(t)?(u.worn=!1,e.message("[You] remove [the object].",u),DONE):NOTDONE;if(!u||"inventory"!=u.location&&u.location!==a.location){if("clothes"!=t.noun&&"all"!=t.noun)return e.message("[You are] not wearing that."),NOTDONE;var m=e.objects.filter(function(t){return"inventory"==t.location&&t.worn&&!t.hidden});if(0===m.length)return e.message("[You are] not wearing anything."),NOTDONE;for(i in m)if(t.noun=m[i].noun,t.adjective=m[i].adjective,t.object=m[i],!e.check(t))return NOTDONE;for(i in m)m[i].worn=!1;return e.message("[You] remove [the list].",m),DONE}return u.wearable?e.message("You are not wearing [the object].",u):e.message("[You] can't wear [the object].",u),NOTDONE;case"wear":if(u&&"inventory"==u.location&&u.wearable)return u.worn?(e.message("[You are] already wearing [the object].",u),NOTDONE):e.check(t)?(u.worn=!0,e.message("[You] put on [the object].",u),DONE):NOTDONE;if(u&&e.inReach(u.location)&&u.wearable)return r=e.currentMessage,(s=e.execute(t,{verb:"take"}))!=DONE?s:(e.currentMessage=r,e.check(t)?(e.message("[You] put on [the object].",u),u.worn=!0,DONE):(u.location=a.location,NOTDONE));if(!u||"inventory"!==u.location&&u.location!==a.location){if("all"!=t.noun)return e.message("[You] can't wear that."),NOTDONE;if(0===(n=e.objects.filter(function(t){return"inventory"===t.location&&t.wearable&&!t.hidden})).length)return e.message("[You] can see nothing suitable."),NOTDONE;for(i in n)if(t.noun=n[i].name,t.adjective=n[i].adjective,!e.check(t))return NOTDONE;for(i in n)n[i].worn=!0;return e.message("[You are] now wearing [the list].",n),DONE}return u.worn?e.message("[You are] already wearing [the object].",u):e.message("[You] can't wear [the object].",u),NOTDONE;case"sit":case"lay":if(o="sit"==t.verb?"sitting":"laying",t.noun||t.unknownWords||1==(n=e.objects.filter(function(t){return t.location===e.player.location&&("sitting"==o?t.sitting:t.laying)})).length&&(t.noun=n[0].noun,t.object=u=n[0]),!u&&e.player.sitting&&!0!==e.player.sitting&&e.findObject(e.player.sitting).laying&&(u=e.findObject(e.player.sitting)),e.player.sitting){if((!0===e.player.sitting&&!u||e.player.sitting==u.key)&&e.player.sittingMode==o)return u?e.message("[You are] already "+o+" on [the object].",u):e.message("[You are] already "+o+" down."),NOTDONE;if(!u||e.player.sitting!=u.key){if((s=e.execute("stand up"))!==DONE)return s;e.currentMessage=""}}return u&&e.present(u)?u.sitting||"sitting"!=o?u.laying||"laying"!=o?(e.player.sitting=u.key,e.player.sittingMode=o,e.message("[You] "+("sitting"==o?"sit":"lay down")+" on [the object].",u),DONE):(e.message("[The object] is not suitable for laying down.",u),NOTDONE):(e.message("[The object] is not suitable for sitting.",u),NOTDONE):t.noun&&"floor"!=t.noun||t.unknownWords?(console.log(t,u),e.message("That's not suitable for sitting."),NOTDONE):(e.player.sitting=!0,e.player.sittingMode=o,console.log(o),e.message("[You] "+("sitting"==o?"sit":"lay")+" down on the floor."),DONE);case"stand":return e.player.sitting?(e.player.sitting=null,e.message("[You] stand up.")):e.message("[You are] already standing."),DONE}return NOACTION}});var Font=function(){this.characterWidth=new Uint8Array(256),this.characterBaseLine=new Uint8Array(256),this.characterDescend=new Uint8Array(256),this.characterAdvance=new Uint8Array(256),this.characterRectX=new Uint16Array(256),this.characterRectY=new Uint16Array(256),this.characterOffsetX=new Int8Array(256),this.image=null,this.lineHeight=16,this.kernings={},this.encoding="ISO8859-1"};Font.prototype.charAdvance=function(t){return this.characterAdvance[t]},Font.prototype.charBaseLine=function(t){return this.characterBaseLine[t]},Font.prototype.charDescend=function(t){return this.characterDescend[t]},Font.prototype.charOffsetX=function(t){return this.characterOffsetX[t]},Font.prototype.charRectX=function(t){return this.characterRectX[t]},Font.prototype.charRectY=function(t){return this.characterRectY[t]},Font.prototype.charRectWidth=function(t){return this.characterWidth[t]},Font.prototype.charRectHeight=function(t){return this.characterBaseLine[t]+this.characterDescend[t]},Font.prototype.loadBitfontMakerData=function(t){this.image=document.createElement("canvas"),this.image.width=256,this.image.height=256;var e,i,n,s=this.image.getContext("2d"),r=s.createImageData(256,256),o=r.data,a=new Uint8Array(256),h=16;for(e in t)if(!((i=0|e)<=0||255<i))for(n=0;n<h;n++)t[e][n]&&(h=n);for(e in t)if(!((i=0|e)<=0||255<i)){var u=t[e],c=16*(i/16|0),l=i%16*16,f=h;for(a[i]=0,n=l;n<l+16;n++)for(var d=u[f++],p=1,g=4*c+1024*n,v=0;v<16;v++){0!=(d&p)&&a[i]<v+1&&(a[i]=v+1);var m=0==(d&p)?0:255;o[g++]=m,o[g++]=m,o[g++]=m,o[g++]=m,p<<=1}this.characterRectX[i]=c,this.characterRectY[i]=l,this.characterWidth[i]=a[i]}for(i=0;i<256;i++)t[i]&&(this.characterBaseLine[i]=11-h,this.characterDescend[i]=4,this.characterAdvance[i]=a[i]-1,this.characterOffsetX[i]=-2);this.characterAdvance[32]=4,s.putImageData(r,0,0),this.lineHeight=14-h,this.encoding="ISO8859-1"},Font.prototype.loadExtendedFont=function(t){function e(t,e){return t[e]|t[e+1]<<8|t[e+2]<<16|t[e+3]<<24}function i(t,e){return t[e]|t[e+1]<<8}function n(t,e){var i=t[e];return 127<i?i-256:i}function s(t,e,i,n,s,r,o){var a=128;function h(){1==a?(a=128,s++):a>>=1}for(var u=0;u<o;u++){for(var c=e,l=0;l<r;l++){if(0==(n[s]&a))t[e++]=0,t[e++]=0,t[e++]=0,t[e++]=0;else if(h(),0==(n[s]&a))t[e++]=255,t[e++]=255,t[e++]=255,t[e++]=255;else{var f=60;h(),0!=(n[s]&a)&&(f+=80),h(),0!=(n[s]&a)&&(f+=56),h(),0!=(n[s]&a)&&(f+=28),t[e++]=255,t[e++]=255,t[e++]=255,t[e++]=f}h()}e=c+i}}var r,o=e(t,8),a=e(t,12),h=e(t,16),u=e(t,20),c=28+a,l=c+8*h,f=0,d=0,p=l;for(r=0;r<o;r++,p+=12)f=Math.max(f,t[p+7]),d+=t[p+8];for(var g=128,v=d/256|0;g<(v+1)*f;)g<<=1;this.image=document.createElement("canvas"),this.image.width=g,this.image.height=256;var m=this.image.getContext("2d"),b=m.createImageData(g,256);p=l;var y,w,x=0,C=0,O=b.data;for(r=0;r<o;r++,p+=12){var N=e(t,p),A=(y=t)[w=p+4]|y[w+1]<<8|y[w+2]<<16,k=t[p+7],T=t[p+8],B=n(t,p+9),W=n(t,p+10),j=n(t,p+11);if(this.characterAdvance[N]=j,0<=N&&N<256)256<C+T&&(C=0,x+=f),this.characterBaseLine[N]=-W-1,this.characterDescend[N]=T-this.characterBaseLine[N],this.characterWidth[N]=k,this.characterRectX[N]=x,this.characterRectY[N]=C,this.characterOffsetX[N]=B,s(O,4*g*C+4*x,4*g,t,A+28,k,T),C+=T}for(p=c,r=0;r<h;r++,p+=8){var I=i(t,p),S=i(t,p+2),D=e(t,p+4);I in this.kernings||(this.kernings[I]={}),this.kernings[I][S]=D,console.log("Kerning '"+String.fromCharCode(I)+"/"+String.fromCharCode(S)+"': "+D)}m.putImageData(b,0,0),this.lineHeight=u},Font.prototype.loadLegacyFont=function(t,e){this.image=document.createElement("canvas"),this.image.width=256,this.image.height=256;var i,n,s,r=this.image.getContext("2d"),o=r.createImageData(256,256),a=o.data;for(n=0;n<256;n++){var h=16*(n/16|0),u=n%16*16,c=e[n],l=16*n;for(i=u;i<u+16;i++){s=t[l++];for(var f=1,d=4*h+1024*i,p=0;p<c;p++){var g=0==(s&f)?0:255;a[d++]=g,a[d++]=g,a[d++]=g,a[d++]=g,f<<=1}}this.characterRectX[n]=h,this.characterRectY[n]=u,this.characterWidth[n]=c}var v=15;for(i=15;0<=i;i--)if(0!==(s=t[1040+i])){v=i;break}for(n=0;n<256;n++)this.characterBaseLine[n]=v,this.characterDescend[n]=15-v,this.characterAdvance[n]=e[n],this.characterOffsetX[n]=0;r.putImageData(o,0,0),this.lineHeight=12,this.encoding="CP437"};var fonts={load:function(o,a){resources.loadBinary(a,function(t){console.log("Font "+o+' loaded from "'+a+'" ('+t.length+" bytes)");var e,i,n="";for(e=0;e<4;e++)n+=String.fromCharCode(t[e]);if("ADVC"==n){i=new Font;var s=new Uint8Array(256),r=new Uint16Array(4096);for(e=0;e<4096;e++)r[e]=256*t[5+2*e]+t[4+2*e];for(e=0;e<256;e++)s[e]=t[8196+e];i.loadLegacyFont(r,s),fonts[o]=i}else"XTNF"==n&&((i=new Font).loadExtendedFont(t),fonts[o]=i)})}},GraphicWindow=function(t,e,i,n,s){this.left=t,this.top=e,this.width=i,this.height=n,this.scrollScreens=2,this.background="",this.transparent=!1,this.resolutionMultiplier=s?2:1,this.scaling=1,this.baseX=0,this.baseY=0,this.lastFrameTime=0,this.frontBuffer=document.createElement("canvas"),this.frontBuffer.width=i*this.resolutionMultiplier,this.frontBuffer.height=n*this.resolutionMultiplier,this.frontBuffer.style.width=this.width+"px",this.frontBuffer.style.height=this.height+"px",this.frontBufferCtx=this.frontBuffer.getContext("2d"),this.frontBuffer.setAttribute("name",i+"x"+n+" frontBuffer"),output.setCanvasStyle(this.frontBuffer),this.screen=document.createElement("canvas"),this.screen.width=this.width*this.resolutionMultiplier,this.screen.height=this.height*this.resolutionMultiplier,this.screenCtx=this.screen.getContext("2d"),this.screenCtx.clearRect(0,0,this.width,this.height),this.screenOffset=0,this.screen.setAttribute("name",i+"x"+n+" screen"),output.setCanvasStyle(this.screen),this.fadeOutTime=.5,this.fadeInRemaining=0,this.fadeOutRemaining=0,this.resizeCanvas(t,e,1)};function KeySpline(h,e,u,i){function c(t,e){return 1-3*e+3*t}function l(t,e){return 3*e-6*t}function f(t){return 3*t}function d(t,e,i){return((c(e,i)*t+l(e,i))*t+f(e))*t}this.get=function(t){return h==e&&u==i?t:d(function(t){for(var e=t,i=0;i<4;++i){var n=(r=e,3*c(o=h,a=u)*r*r+2*l(o,a)*r+f(o));if(0===n)return e;var s=d(e,h,u)-t;e-=s/n}var r,o,a;return e}(t),e,i)}}GraphicWindow.prototype.enableHiDPI=function(){2!=this.resolutionMultiplier&&(this.resolutionMultiplier=2,this.screen.width=2*this.width,this.screen.height=2*this.height,this.screenCtx=this.screen.getContext("2d"),this.screenCtx.clearRect(0,0,2*this.width,2*this.height),this.resizeCanvas(this.baseX,this.baseY,this.scaling))},GraphicWindow.prototype.resizeCanvas=function(t,e,i){this.baseX=t,this.baseY=e,this.scaling=i,this.frontBuffer.width=this.width*i*this.resolutionMultiplier,this.frontBuffer.height=this.height*i*this.resolutionMultiplier,this.frontBuffer.style.width=this.width*i+"px",this.frontBuffer.style.height=this.height*i+"px",this.frontBuffer.style.left=this.left*i+t+"px",this.frontBuffer.style.top=this.top*i+e+"px",this.frontBufferCtx=this.frontBuffer.getContext("2d"),this.frontBufferCtx.setTransform(i,0,0,i,0,0),this.redrawCanvas()},GraphicWindow.prototype.clear=function(t){console.log("Clearing",this.width+"x"+this.height,"canvas with resolution multiplier",this.resolutionMultiplier),void 0===t?(this.screenCtx.clearRect(0,0,this.width*this.resolutionMultiplier,this.height*this.resolutionMultiplier),this.transparent=!0):(this.screenCtx.fillStyle=t,this.screenCtx.fillRect(0,0,this.width*this.resolutionMultiplier,this.height*this.resolutionMultiplier),this.transparent=!1),this.background=null,this.redrawCanvas()},GraphicWindow.prototype.drawBackground=function(t,e,i){this.background!==t&&(this.background=t,this.drawImage(t,e,i))},GraphicWindow.prototype.drawImage=function(t,e,i){e||(e=0),i||(i=0);var n=new Image,s=this,r=s.resolutionMultiplier;n.onload=function(){s.screenCtx.drawImage(n,0,0,n.width*r,n.height*r,e,i,n.width*r,n.height*r),s.redrawCanvas()},n.src=t},GraphicWindow.prototype.redrawCanvas=function(){var t;this.frontBufferCtx.clearRect(0,0,this.width*this.resolutionMultiplier,this.height*this.resolutionMultiplier),this.frontBufferCtx.mozImageSmoothingEnabled=!1,this.frontBufferCtx.msImageSmoothingEnabled=!1,"boolean"==typeof this.frontBufferCtx.imageSmoothingEnabled?this.frontBufferCtx.imageSmoothingEnabled=!1:this.frontBufferCtx.webkitImageSmoothingEnabled=!1,0<this.fadeOutRemaining?this.frontBufferCtx.globalAlpha=Math.pow(this.fadeOutRemaining/this.fadeOutTime,2):0<this.fadeInRemaining?this.frontBufferCtx.globalAlpha=Math.pow(1-this.fadeInRemaining/this.fadeOutTime,2):this.frontBufferCtx.globalAlpha=1;var e=this.resolutionMultiplier;if(this.screenOffset<0){var i=this.height*this.scrollScreens+this.screenOffset;t=-this.screenOffset,this.frontBufferCtx.drawImage(this.screen,0,i*e,this.width*e,t*e,0,0,this.width*e,t*e),this.frontBufferCtx.drawImage(this.screen,0,0,this.width*e,(this.height-t)*e,0,t*e,this.width*e,(this.height-t)*e)}else this.screenOffset>this.height*(this.scrollScreens-1)?(t=this.height*this.scrollScreens-this.screenOffset,this.frontBufferCtx.drawImage(this.screen,0,this.screenOffset*e,this.width*e,t*e,0,0,this.width*e,t*e),this.frontBufferCtx.drawImage(this.screen,0,0,this.width*e,this.height*e-t*e,0,t*e,this.width*e,(this.height-t)*e)):this.frontBufferCtx.drawImage(this.screen,0,this.screenOffset*e,this.width*e,this.height*e,0,0,this.width*e,this.height*e)},GraphicWindow.prototype.animationFrame=function(t){0===this.lastFrameTime&&(this.lastFrameTime=t);var e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t;var i=!1;0<this.fadeOutRemaining?(this.fadeOutRemaining-=e,this.fadeOutRemaining=Math.max(0,this.fadeOutRemaining),i=!0):0<this.fadeInRemaining&&(this.fadeInRemaining-=e,this.fadeInRemaining=Math.max(0,this.fadeInRemaining),i=!0),i&&this.redrawCanvas()};var Output=function(){this.screenWidth=480,this.screenHeight=300,this.showScanlines=!0,this.scanlines=null,this.scanlinesOpacity=.25,this.scanlineScaling=null,this.scaling=1,this.windows=[]};Output.prototype.initialize=function(){this.frontBuffer=document.createElement("canvas"),this.frontBuffer.width=this.screenWidth,this.frontBuffer.height=this.screenHeight,this.frontBufferCtx=this.frontBuffer.getContext("2d"),this.setCanvasStyle(this.frontBuffer),this.autoResizeCanvas(),document.body.appendChild(this.frontBuffer);for(var r=0,t=["webkit","moz"],e=this,i=0;i<t.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[i]+"CancelAnimationFrame"]||window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t,e){var i=(new Date).getTime(),n=Math.max(0,16-(i-r)),s=window.setTimeout(function(){t(i+n)},n);return r=i+n,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)}),window.onresize=function(){e.autoResizeCanvas()},document.onkeypress=function(t){e.keyPressed(t)},document.onkeydown=function(t){e.keyDown(t)}},Output.prototype.setCanvasStyle=function(t){t.style.position="absolute",t.style.outline="none",t.style.imageRendering="optimizeSpeed",t.style.imageRendering="optimize-contrast",t.style.imageRendering="-webkit-optimize-contrast",t.style.imageRendering="-moz-crisp-edges",t.style.msInterpolationMode="nearest-neighbor",t.style.imageRendering="pixelated"},Output.prototype.createTextWindow=function(t,e,i,n){var s=new TextWindow(t,e,i,n);return this.windows.push(s),s.frontBuffer.tabIndex=this.windows.length,s.frontBuffer.style.zIndex=this.windows.length-1,this.frontBuffer.style.zIndex=this.windows.length,this.autoResizeCanvas(),document.body.appendChild(s.frontBuffer),s},Output.prototype.createGraphicWindow=function(t,e,i,n,s){var r=new GraphicWindow(t,e,i,n,s);return this.windows.push(r),r.frontBuffer.tabIndex=this.windows.length,r.frontBuffer.style.zIndex=this.windows.length-1,this.frontBuffer.style.zIndex=this.windows.length,this.autoResizeCanvas(),document.body.appendChild(r.frontBuffer),r},Output.prototype.buildScanlines=function(){var t;for(this.scanlines=document.createElement("canvas"),this.setCanvasStyle(this.scanlines),this.scanlinesScaling=this.scaling,3<this.scaling&&(this.scanlinesScaling/=2),this.scanlines.width=this.screenWidth*this.scanlinesScaling,this.scanlines.height=this.screenHeight*this.scanlinesScaling,this.scanlinesCtx=this.scanlines.getContext("2d"),this.scanlinesCtx.strokeStyle="black",this.scanlinesCtx.lineWidth=1,this.scanlinesCtx.globalAlpha=this.scanlinesOpacity,this.scanlinesCtx.beginPath(),t=0;t<this.screenHeight*this.scanlinesScaling;t+=this.scanlinesScaling)this.scanlinesCtx.moveTo(0,t-.5),this.scanlinesCtx.lineTo(4*this.screenWidth,t-.5);if(3==this.scanlinesScaling)for(this.scanlinesCtx.stroke(),this.scanlinesCtx.beginPath(),this.scanlinesCtx.globalAlpha=this.scanlinesOpacity/2,t=this.scanlinesScaling-1;t<this.screenHeight*this.scanlinesScaling;t+=this.scanlinesScaling)this.scanlinesCtx.moveTo(0,t-.5),this.scanlinesCtx.lineTo(4*this.screenWidth,t-.5);this.scanlinesCtx.stroke()},Output.prototype.autoResizeCanvas=function(){var t=Math.floor(window.innerWidth/this.screenWidth),e=Math.floor(window.innerHeight/this.screenHeight),i=Math.max(1,Math.min(t,e)),n=window.innerWidth/2-this.screenWidth*i/2,s=window.innerHeight/2-this.screenHeight*i/2;this.frontBuffer.width=this.screenWidth*i,this.frontBuffer.height=this.screenHeight*i,this.frontBuffer.style.left=n+"px",this.frontBuffer.style.top=s+"px",this.frontBufferCtx.setTransform(i,0,0,i,0,0),this.scaling=i;for(var r=0;r<this.windows.length;r++)this.windows[r].resizeCanvas(n,s,i);this.redrawScanlines(null===this.scanlines||this.scanlinesScaling!=this.scaling),this.redrawCanvas()},Output.prototype.redrawScanlines=function(t){this.frontBufferCtx.clearRect(0,0,this.screenWidth,this.screenHeight),this.frontBufferCtx.mozImageSmoothingEnabled=!1,this.frontBufferCtx.msImageSmoothingEnabled=!1,"boolean"==typeof this.frontBufferCtx.imageSmoothingEnabled?this.frontBufferCtx.imageSmoothingEnabled=!1:this.frontBufferCtx.webkitImageSmoothingEnabled=!1,t&&this.buildScanlines(),this.frontBufferCtx.globalAlpha=1,this.frontBufferCtx.drawImage(this.scanlines,0,0,this.screenWidth*this.scanlinesScaling,this.screenHeight*this.scanlinesScaling,0,0,this.screenWidth,this.screenHeight)},Output.prototype.redrawCanvas=function(){1<this.scaling&&this.showScanlines?(null!==this.scanlines&&this.scanlinesScaling==this.scaling||this.redrawScanlines(!0),this.frontBuffer.style.visibility="visible"):this.frontBuffer.style.visibility="hidden"},Output.prototype.keyPressed=function(t){for(var e=0;e<this.windows.length;e++)if(this.windows[e].inputActive||this.windows[e].waitingForKey){this.windows[e].keyPressed(t);break}},Output.prototype.keyDown=function(t){for(var e=0;e<this.windows.length;e++)if(this.windows[e].inputActive||this.windows[e].waitingForKey){this.windows[e].keyDown(t);break}},Output.prototype.startAnimation=function(){window.requestAnimationFrame(function(t){output.animationFrame(t)})},Output.prototype.animationFrame=function(t){for(var e=0;e<this.windows.length;e++)this.windows[e].animationFrame(t);this.redrawCanvas(),this.startAnimation()};var output=new Output,resources={pending:[],cached:[],callbacks:[],onload:function(t){this.callbacks.push(t)},get:function(t){return this.cached[t]},loadBinary:function(n,s){if(n in this.cached)null!==s&&s(this.cached[n]);else{this.pending[n]=!0;var r=new XMLHttpRequest;r.open("GET",n,!0),r.responseType="arraybuffer",r.onload=function(t){resources.pending[n]=!1;var e=r.response;if(e){var i=new Uint8Array(e);resources.cached[n]=i,null!==s&&s(i),resources.noMorePending()&&resources.invokeCallbacks()}else console.log("Error reading "+n+": empty response")},r.error=function(t){console.log("req.error called. Error: "+t),resources.pending[n]=!1,resources.noMorePending()&&resources.invokeCallbacks()},r.send(null)}},noMorePending:function(){var t=0;for(var e in this.pending){if(!0===this.pending[e])return!1;t++}return console.log("No more pending resources found ("+t+" in memory)"),!0},invokeCallbacks:function(){for(var t=0;t<this.callbacks.length;t++)this.callbacks[t]()}},TextWindow=function(t,e,i,n){this.left=t,this.top=e,this.width=i,this.height=n,this.scrollScreens=2,this.leftIndent=0,this.rightIndent=0,this.frenchIndent=0,this.currentAlignment="left",this.defaultColor="#ccc",this.currentFont=null,this.currentX=0,this.currentY=0,this.currentScreenY=0,this.currentBufferedText="",this.currentLineHeight=0,this.currentLineBaseLine=0,this.currentLineDescent=0,this.rightMostX=0,this.currentColor="#ccc",this.paragraphStart=!0,this.fullScreen=!1,this.lastFrameTime=0,this.inputPrompt="> ",this.inputCursorColor=null,this.inputCursorAlpha=1,this.inputCursorStyle="line",this.inputCursorBlinkStyle="off",this.inputCursorLeft=1,this.inputCursorBottom=0,this.inputText="",this.inputActive=!1,this.inputCursorChar=0,this.inputCursorX=0,this.inputPrintMode=!1,this.inputUpdated=!1,this.inputBlinkTime=.2666666666666667,this.inputBlinkRemaining=.2,this.inputBlinkStatus=!1,this.inputAccepted=!1,this.inputTextWidth=0,this.inputOffset=0,this.inputHistory=[],this.inputHistoryIndex=0,this.waitingForKey=!1,this.keyCallbacks=[],this.keyCallbacksFlush=[],this.frontBuffer=document.createElement("canvas"),this.frontBuffer.width=i,this.frontBuffer.height=n,this.frontBufferCtx=this.frontBuffer.getContext("2d"),output.setCanvasStyle(this.frontBuffer),this.screen=document.createElement("canvas"),this.screen.width=this.width,this.screen.height=this.height*this.scrollScreens,this.screenCtx=this.screen.getContext("2d"),this.screenCtx.clearRect(0,0,this.width,this.height),this.screenOffset=0,output.setCanvasStyle(this.screen),this.lineBufferHeight=64,this.lineBuffer=document.createElement("canvas"),this.lineBuffer.width=this.width,this.lineBuffer.height=this.lineBufferHeight,this.lineBufferCtx=this.lineBuffer.getContext("2d"),this.lineBufferCtx.clearRect(0,0,this.width,this.lineBufferHeight),output.setCanvasStyle(this.lineBuffer),this.scrollPosition=0,this.scrollActive=!1,this.scrollDown=!1,this.scrollLines=this.height,this.scrollTime=.4,this.scrollBegan=this.lastFrameTime,this.fadeOutTime=.5,this.fadeInRemaining=0,this.fadeOutRemaining=0,this.scrollSpline=new KeySpline(.1,.62,.63,1)};TextWindow.prototype.resizeCanvas=function(t,e,i){this.scaling=i,this.frontBuffer.width=this.width*i,this.frontBuffer.height=this.height*i,this.frontBuffer.style.left=this.left*i+t+"px",this.frontBuffer.style.top=this.top*i+e+"px",this.frontBufferCtx.setTransform(i,0,0,i,0,0),this.redrawCanvas()},TextWindow.prototype.redrawCanvas=function(){var t;if(this.frontBufferCtx.clearRect(0,0,this.width,this.height),this.frontBufferCtx.mozImageSmoothingEnabled=!1,this.frontBufferCtx.msImageSmoothingEnabled=!1,"boolean"==typeof this.frontBufferCtx.imageSmoothingEnabled?this.frontBufferCtx.imageSmoothingEnabled=!1:this.frontBufferCtx.webkitImageSmoothingEnabled=!1,0<this.fadeOutRemaining?this.frontBufferCtx.globalAlpha=Math.pow(this.fadeOutRemaining/this.fadeOutTime,2):0<this.fadeInRemaining?this.frontBufferCtx.globalAlpha=Math.pow(1-this.fadeInRemaining/this.fadeOutTime,2):this.frontBufferCtx.globalAlpha=1,this.screenOffset<0){var e=this.height*this.scrollScreens+this.screenOffset;t=-this.screenOffset,this.frontBufferCtx.drawImage(this.screen,0,e,this.width,t,0,0,this.width,t),this.frontBufferCtx.drawImage(this.screen,0,0,this.width,this.height-t,0,t,this.width,this.height-t)}else this.screenOffset>this.height*(this.scrollScreens-1)?(0<(t=this.height*this.scrollScreens-this.screenOffset)&&this.frontBufferCtx.drawImage(this.screen,0,this.screenOffset,this.width,t,0,0,this.width,t),0<this.height-t&&this.frontBufferCtx.drawImage(this.screen,0,0,this.width,this.height-t,0,t,this.width,this.height-t)):this.frontBufferCtx.drawImage(this.screen,0,this.screenOffset,this.width,this.height,0,0,this.width,this.height)},TextWindow.prototype.scrollIfNeeded=function(t){this.currentScreenY+t>this.height&&(this.scrollActive=!0,this.scrollBegan=this.lastFrameTime,this.scrollLines=this.currentScreenY+t-this.height,this.scrollPosition=0,this.scrollTime=.005*this.scrollLines)},TextWindow.prototype.waitForKey=function(t){this.flush(),this.scrollIfNeeded(0),this.redrawCanvas(),this.waitingForKey=!0,this.keyCallbacks.push(t),this.keyCallbacksFlush.push(this.currentBufferedText.length)},TextWindow.prototype.startInput=function(e){if(this.flush(),this.inputText="",this.inputCursorX=0,this.inputCursorChar=0,this.inputActive=!0,this.inputUpdated=!0,this.inputOffset=0,this.inputHistoryIndex=this.inputHistory.length,this.inputHistory.push(""),this.inputPromptFinal||(this.inputPromptFinal=this.inputPrompt),this.waitingForKey||(this._clearLine(this.currentFont.lineHeight+this.inputCursorBottom),this.scrollIfNeeded(this.currentFont.lineHeight+this.inputCursorBottom)),e){var i=this.oninput;this.oninput=function(t){e(t),this.oninput=i}}},TextWindow.prototype._printInputLine=function(){this.print("\0"),this._clearLine(),this.currentX=0,this.inputPrintMode=!0,this.print(this.inputActive?this.inputPrompt:this.inputPromptFinal),this.inputCursorX=this.subtextWidth(this.inputText,0,this.inputCursorChar),this.inputTextWidth=this.textWidth(this.inputText);var t=this.lineBufferHeight/2-this.currentLineBaseLine,e=this.lineBufferHeight/2+this.currentLineDescent-1-t,i=this.width-this.currentX;this.inputOffset<this.inputCursorX-i+2&&(this.inputOffset=this.inputCursorX-i+2),this.inputOffset>this.inputCursorX&&(this.inputOffset=this.inputCursorX),this.inputOffset<0&&(this.inputOffset=0);var n=this.currentX-this.inputOffset;this.lineBufferCtx.save(),this.lineBufferCtx.beginPath(),this.lineBufferCtx.rect(this.currentX,t,this.width,e),this.lineBufferCtx.clip(),this.printAtC(n,this.currentY,this.currentColor,this.inputText);var s=this.inputCursorStyle;if(!0===this.inputBlinkStatus&&(s=this.inputCursorBlinkStyle),"off"!==s){var r=1,o=this.currentLineHeight-1+this.inputCursorBottom,a=n+this.inputCursorX+this.inputCursorLeft,h=t;"line"!==s&&(r=this.subtextWidth(this.inputText,this.inputCursorChar,this.inputCursorChar+1)-1)<0&&(r=this.currentFont.charRectWidth(65)-1),"underline"===s&&(h=t+o-1,o=1),this.lineBufferCtx.beginPath(),this.lineBufferCtx.rect(a,h,r,o),this.lineBufferCtx.fillStyle=null===this.inputCursorColor?this.currentColor:this.inputCursorColor,this.lineBufferCtx.clip(),this.lineBufferCtx.globalCompositeOperation="source-out",this.lineBufferCtx.globalAlpha=this.inputCursorAlpha,this.lineBufferCtx.fill()}this.lineBufferCtx.restore(),this.inputPrintMode=!1,this._updateLine()},TextWindow.prototype.keyPressed=function(t){if(this.waitingForKey){if(t.preventDefault(),this.waitingForKey=!1,0<this.keyCallbacks.length){var e=this.keyCallbacks.pop(),i=this.keyCallbacksFlush.pop();if(e&&e(),0<this.keyCallbacks.length){var n=this.currentBufferedText.substring(i);this.currentBufferedText=this.currentBufferedText.substring(0,i),this.flush(),this.scrollIfNeeded(),this.waitingForKey=!0,this.currentBufferedText=n}else this.inputActive&&(this.flush(),this.scrollIfNeeded(this.currentFont.lineHeight))}return!0}if(!0!==this.inputActive)return!1;var s=t.which,r=s;switch("CP437"===this.currentFont.encoding&&(r=iso8859tocp437[s]),32<=r&&r<256&&(this.inputText=this.inputText.substring(0,this.inputCursorChar)+String.fromCharCode(r)+this.inputText.substring(this.inputCursorChar),this.inputCursorChar++,this.inputUpdated=!0),s){case 8:0<this.inputCursorChar&&(this.inputText=this.inputText.substring(0,this.inputCursorChar-1)+this.inputText.substring(this.inputCursorChar),this.inputCursorChar--,this.inputUpdated=!0),t.preventDefault();break;case 13:if(""!=this.inputText){this.inputHistory[this.inputHistory.length-1]=this.inputText,this.inputActive=!1,this.inputBlinkStatus=!0,this.inputCursorChar=0,this.print("\0"),this._clearLine(),this.currentX=0,this.paragraphStart=!0,this.print(null===this.inputPromptFinal?this.inputPrompt:this.inputPromptFinal);var o=this.frenchIndent;this.frenchIndent=this.currentX,this.print(this.inputText),this.print("<r>\n"),this.frenchIndent=o,this.oninput&&this.oninput(this.inputText)}break;case 1:this.inputCursorChar=0,this.inputUpdated=!0;break;case 5:this.inputCursorChar=this.inputText.length,this.inputUpdated=!0}return this.inputUpdated&&t.preventDefault(),this.inputUpdated},TextWindow.prototype.keyDown=function(t){var e=t.keyCode;switch(e){case 112:!1===output.showScanlines?(output.showScanlines=!0,output.scanlinesOpacity=.5,output.scanlinesScaling=-1):.5===output.scanlinesOpacity?(output.scanlinesOpacity=.25,output.scanlinesScaling=-1):output.showScanlines=!1,t.preventDefault();break;case 121:this.fullScreen=!this.fullScreen;var i=document.body;i.requestFullscreen?(this.fullScreen?i.requestFullscreen():document.exitFullscreen(),console.log("Showing HTML5 full screen")):i.webkitRequestFullscreen&&(this.fullScreen?i.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT):document.webkitExitFullscreen(),console.log("Showing webkit full screen"))}if(!0===this.inputActive&&!this.waitingForKey){switch(e){case 8:0<this.inputCursorChar&&(this.inputText=this.inputText.substring(0,this.inputCursorChar-1)+this.inputText.substring(this.inputCursorChar),this.inputCursorChar--,this.inputUpdated=!0),t.preventDefault();break;case 27:this.inputText="",this.inputCursorChar=0,this.inputUpdated=!0;break;case 46:this.inputText=this.inputText.substring(0,this.inputCursorChar)+this.inputText.substring(this.inputCursorChar+1),this.inputUpdated=!0;break;case 37:0<this.inputCursorChar&&this.inputCursorChar--,this.inputUpdated=!0;break;case 38:this.inputHistory[this.inputHistoryIndex]=this.inputText,--this.inputHistoryIndex<0&&(this.inputHistoryIndex=this.inputHistory.length-1),this.inputText=this.inputHistory[this.inputHistoryIndex],this.inputCursorChar=this.inputText.length,this.inputUpdated=!0;break;case 39:this.inputCursorChar<this.inputText.length&&this.inputCursorChar++,this.inputUpdated=!0;break;case 40:this.inputHistory[this.inputHistoryIndex]=this.inputText,++this.inputHistoryIndex==this.inputHistory.length&&(this.inputHistoryIndex=0),this.inputText=this.inputHistory[this.inputHistoryIndex],this.inputCursorChar=this.inputText.length,this.inputUpdated=!0;break;case 33:case 36:this.inputCursorChar=0,this.inputUpdated=!0;break;case 34:case 35:this.inputCursorChar=this.inputText.length,this.inputUpdated=!0}return this.inputUpdated&&t.preventDefault(),this.inputUpdated}},TextWindow.prototype.scrollContents=function(t){var e=this.height*this.scrollScreens;(t|=0)<-e&&(t=- -t%e),e<t&&(t%=e),this.screenOffset+=t,this.currentScreenY-=t,this.screenOffset<0?this.screenOffset+=e:this.screenOffset>=e&&(this.screenOffset-=e)},TextWindow.prototype.animationFrame=function(t){0===this.lastFrameTime&&(this.lastFrameTime=t);var e=(t-this.lastFrameTime)/1e3;this.lastFrameTime=t;var i=!1;if(0<this.fadeOutRemaining?(this.fadeOutRemaining-=e,this.fadeOutRemaining=Math.max(0,this.fadeOutRemaining),i=!0):0<this.fadeInRemaining&&(this.fadeInRemaining-=e,this.fadeInRemaining=Math.max(0,this.fadeInRemaining),i=!0),this.scrollActive){var n=(t-this.scrollBegan)/1e3/this.scrollTime;1<n&&(n=1);var s=(this.scrollSpline.get(n)*this.scrollLines|0)-this.scrollPosition;0!==s&&(this.scrollContents(this.scrollDown?-s:s),this.scrollPosition+=s),1<=n&&(this.scrollActive=!1),i=!0}if(this.inputActive&&!this.waitingForKey&&(this.inputUpdated?(this.inputUpdated=!1,this.inputBlinkRemaining=2*this.inputBlinkTime,this.inputBlinkStatus=!1,this._printInputLine(),i=!0):(this.inputBlinkRemaining-=e,this.inputBlinkRemaining<=0&&(this.inputBlinkRemaining=this.inputBlinkTime,this.inputBlinkStatus=!this.inputBlinkStatus,this._printInputLine(),i=!0))),i&&(this.redrawCanvas(),this.showFPS)){var r=1/e;this.frontBufferCtx.globalAlpha=1,this.frontBufferCtx.fillStyle="white",this.frontBufferCtx.fillText((0|r)+" fps",0,10)}},TextWindow.prototype.subtextWidth=function(t,e,i){for(var n=this.currentFont.characterAdvance,s=0,r=e;r<t.length&&r<i;r++)s+=n[t.charCodeAt(r)];return s},TextWindow.prototype.textWidth=function(t){for(var e=this.currentFont.characterAdvance,i=0,n=0;n<t.length;n++){var s=t.charCodeAt(n);s<0||255<s||(i+=e[s])}return i},TextWindow.prototype.parseEscapeString=function(t){var e=t.toLowerCase().split(/[ :=]/);"c"==e[0]||"color"==e[0]?0!==e.length&&e[1]?this.currentColor=e[1]:this.currentColor=this.defaultColor:"/c"==e[0]||"/color"==e[0]?this.currentColor=this.defaultColor:"f"==e[0]||"font"==e[0]?(this.currentFont=fonts[e[1]],this.currentFont||(this.currentFont=fonts[parseInt(e[1])],this.currentFont||(this.currentFont=fonts[0]))):"b"==e[0]?this.currentFont=fonts[1]:"/f"==e[0]||"/font"==e[0]||"/b"==e[0]?this.currentFont=fonts[0]:"r"==e[0]||"reset"==e[0]?(this.currentFont=fonts[0],this.currentColor=this.defaultColor,this.currentAlignment="left"):"center"==e[0]?this.currentAlignment="center":"right"==e[0]?this.currentAlignment="right":"left"==e[0]||"/center"==e[0]||"/right"==e[0]||"/left"==e[0]?this.currentAlignment="left":e[0]in colors?this.currentColor=e[0]:"/"==e[0].charAt(0)&&e[0].substring(1)in colors?this.currentColor=this.defaultColor:"clear"===e[0]?(this._nextLine(),this.scrollActive=!1,this.screenOffset=this.currentY,this.currentScreenY=0,this._clearScreen(),this.redrawCanvas()):(console.log("Unknown escape string: "+t),this.print(t))},TextWindow.prototype.clear=function(){0!==this.currentX&&this._nextLine(),this.scrollActive=!1,this.screenOffset=this.currentY,this.currentScreenY=0,this._clearScreen(),this.redrawCanvas()},TextWindow.prototype.empty=function(){return 0===this.currentY&&0===this.currentX},TextWindow.prototype._clearScreen=function(){var t=this.height*this.scrollScreens;this.screenCtx.clearRect(0,this.currentY,this.width,this.height),this.currentY+this.height>t&&this.screenCtx.clearRect(0,0,this.width,this.currentY+this.height-t)},TextWindow.prototype._clearLine=function(t){t||(t=this.currentLineHeight);var e=this.height*this.scrollScreens;this.screenCtx.clearRect(0,this.currentY,this.width,t),this.currentY+t>e&&this.screenCtx.clearRect(0,0,this.width,this.currentY+t-e)},TextWindow.prototype._updateLine=function(){var t=this.paragraphStart?this.leftIndent:this.leftIndent+this.frenchIndent,e=this.width-t-this.rightIndent;"center"===this.currentAlignment?t+=(e-this.currentX)/2|0:"right"===this.currentAlignment&&(t=this.width-this.rightIndent-this.currentX);var i=this.lineBufferHeight/2-this.currentLineBaseLine,n=this.lineBufferHeight/2+this.currentLineDescent-1-i,s=this.height*this.scrollScreens;if(0<n&&(this.screenCtx.clearRect(0,this.currentY,this.width,n),this.screenCtx.drawImage(this.lineBuffer,0,i,this.width,n,t,this.currentY,this.width,n),this.currentY+n>s)){var r=s-this.currentY,o=this.currentY+n-s;this.screenCtx.clearRect(0,0,this.width,o),this.screenCtx.drawImage(this.lineBuffer,0,i+r,this.width,o,t,0,this.width,o)}this.lineBufferCtx.clearRect(0,i,this.width+1,n+1)},TextWindow.prototype._nextLine=function(){if(!this.inputPrintMode){if(0<this.currentLineHeight){var t=this.height*this.scrollScreens,e=this.currentLineHeight;if(this.screenCtx.clearRect(0,this.currentY,this.width,this.currentLineHeight),this.currentY+this.currentLineHeight>t){var i=this.currentY+e-t;this.screenCtx.clearRect(0,0,this.width,i)}}this._updateLine(),this._moveToNextLine()}},TextWindow.prototype._moveToNextLine=function(){this.currentX=0,this.currentY+=this.currentLineHeight,this.currentScreenY+=this.currentLineHeight,this.currentLineHeight=0,this.currentLineDescent=0,this.currentLineBaseLine=0,this.rightMostX=0,this.currentY>this.height*this.scrollScreens&&(this.currentY-=this.height*this.scrollScreens)},TextWindow.prototype.print=function(t){if(null===this.currentFont&&(this.currentFont=fonts[0]),this.waitingForKey)this.currentBufferedText+=t;else{t=this.currentBufferedText+t,this.currentBufferedText="";var e=this.width-this.leftIndent-this.rightIndent;!1===this.paragraphStart&&(e-=this.frenchIndent);for(var i=0,n=0;n<t.length;n++){var s=t.charCodeAt(n);if(32==s||13==s||10==s||0===s||60==s){var r=this.subtextWidth(t,i,n);if(this.currentX+r>=e&&(this._nextLine(),this.paragraphStart=!1,e=this.width-this.leftIndent-this.rightIndent-this.frenchIndent),this.currentX=this.printAtC(this.currentX,this.currentY,this.currentColor,t.substring(i,n)),32==s)this.currentX+=this.currentFont.charAdvance(32);else if(13==s||10==s)0===this.currentX&&(this.currentLineHeight=this.currentFont.lineHeight),this._nextLine(),this.paragraphStart=!0,e=this.width-this.leftIndent-this.rightIndent;else if(60==s){for(i=n+1;n<t.length&&(n++,62!=(s=t.charCodeAt(n))););if(this.parseEscapeString(t.substring(i,n)),""!==this.currentBufferedText)return void this.print(t.substring(n+1))}i=n+1}}this.currentBufferedText=t.substring(i)}},TextWindow.prototype.flush=function(){this.print("\0"),0<this.currentX&&this._nextLine(),this.redrawCanvas()},TextWindow.prototype.printAt=function(t,e,i){if(0===i.length)return t;this.currentFont||(this.currentFont=fonts[0]);for(var n=this.currentFont,s=0;s<i.length;s++){var r=i.charCodeAt(s);if(!(r<0||255<r)){var o=n.charRectX(r),a=n.charRectY(r),h=n.charRectWidth(r),u=n.charRectHeight(r),c=n.charBaseLine(r),l=n.charDescend(r),f=n.charOffsetX(r);0<u&&0<h&&this.lineBufferCtx.drawImage(n.image,o,a,h,u,t+f,this.lineBufferHeight/2-c,h,u),t+=n.charAdvance(r),this.currentLineDescent<l&&(this.currentLineDescent=l),this.currentLineBaseLine<c&&(this.currentLineBaseLine=c),this.rightMostX<t+f+h&&(this.rightMostX=t+f+h)}}return this.currentLineHeight<n.lineHeight&&(this.currentLineHeight=n.lineHeight),t},TextWindow.prototype.printAtC=function(t,e,i,n){if("white"==i||null===i)return this.printAt(t,e,n);this.currentFont||(this.currentFont=fonts[0]);var s=-this.currentFont.charOffsetX(n.charCodeAt(0)),r=this.printAt(t,e,n),o=this.rightMostX-t;0<s&&(t-=s,o+=s);var a=this.lineBufferHeight/2-this.currentLineBaseLine,h=this.lineBufferHeight/2+this.currentLineDescent-1-a;return this.lineBufferCtx.save(),this.lineBufferCtx.globalCompositeOperation="source-in",this.lineBufferCtx.beginPath(),this.lineBufferCtx.rect(t,a,o,h),this.lineBufferCtx.clip(),this.lineBufferCtx.fillStyle=i,this.lineBufferCtx.fillRect(t,a,o,h),this.lineBufferCtx.restore(),r};
//# sourceMappingURL=adventure-toolkit.min.js.map